# システムについて
WordPressのような動的なページ管理システムの軽量版としてそれっぽいヘッドレスCMSのようなものを作りました。
細かい仕様については記載していませんが管理画面のない簡易wordPressテーマととらえていただければと思います。
内包されていないソフトウェアでpost-data.json(data/post-data.json)を書き換えることが可能で投稿データをsql代わりに扱っています。
システムは簡易的なもので完全には完成していないのでバージョン等の管理は行われていません。
# 動作環境
## php 8.2.4
## apache 2.0

# 追加した機能
# モジュールインクルードデータ管理システム - 使用法と仕様

## 概要

このシステムは、PHPテンプレートでデータを一元管理し、再利用可能なコンポーネントを簡単に呼び出せるようにするものです。グローバル変数 `$_INCLUDE` を使用してデータを管理し、各モジュールで必要なデータを取得・表示できます。

## 基本的な仕組み

1. **データ設定**: ページファイル（home.php等）でデータを設定
2. **データ取得**: 各モジュール内でデータを取得
3. **条件付き出力**: 空データのチェックを行い、適切に表示

---

## 関数リファレンス

### `set_include_data($module_name, $data)`

モジュール用のデータを設定します。

#### パラメータ
- `$module_name` (string): モジュール名（一意の識別子）
- `$data` (mixed): 設定するデータ（配列または単体データ）

#### 使用例
```php
// 単体データ
set_include_data('company', [
    'name' => '株式会社サンプル',
    'tel' => '03-1234-5678'
]);

// 配列データ（複数のアイテム）
set_include_data('beforeAfter', [
    [
        'src' => 'images/case01.jpg',
        'alt' => 'リフォーム事例1',
        'ttl' => 'ベランダ修繕'
    ],
    [
        'src' => 'images/case02.jpg',
        'alt' => 'リフォーム事例2',
        'ttl' => '外壁塗装'
    ]
]);
```

---

### `get_include_data($module_name, $index = null)`

設定されたデータを取得します。

#### パラメータ
- `$module_name` (string): モジュール名
- `$index` (int|null): 配列データの場合のインデックス（省略時は全データ）

#### 戻り値
- 指定されたデータまたは `null`

#### 使用例
```php
// 全データ取得
$company_module = get_include_data('company');

// 配列の特定インデックス取得
$first_case = get_include_data('beforeAfter', 0);

// データ存在チェック
if ($company_module) {
    echo $company_module['name'];
}
```

---

### `render_include_loop($module_name, $include_path)`

配列データをループして、指定されたファイルを繰り返しインクルードします。

#### パラメータ
- `$module_name` (string): モジュール名
- `$include_path` (string): インクルードするファイルパス

#### 動作
- 単体データの場合: 1回だけインクルード
- 配列データの場合: 各要素に対してインクルード
- データが存在しない場合: 何もしない

#### 使用例
```php
// case.php内で
render_include_loop('beforeAfter', 'parts/bl_case/beforeAfter.php');

// faq.php内で
render_include_loop('faq', 'parts/bl_faq/faqItem.php');
```

---

### `output_if_exists($tag_format, $content, $default = '')`

条件付きでHTMLタグを出力します。内容が空の場合は出力しません。

#### パラメータ
- `$tag_format` (string): HTMLタグのフォーマット（`%s`で内容を指定）
- `$content` (string): 出力する内容
- `$default` (string): デフォルト値（省略可）

#### 戻り値
- HTMLタグ文字列または空文字

#### 使用例
```php
// タイトルが存在する場合のみh3タグを出力
echo output_if_exists('<h3 class="title">%s</h3>', $module['ttl'] ?? '');

// 説明文が存在する場合のみpタグを出力
echo output_if_exists('<p class="description">%s</p>', $module['txt'] ?? '');

// デフォルト値付き
echo output_if_exists('<span class="status">%s</span>', $module['status'] ?? '', '未設定');
```

---

## 実装例

### 1. ページファイルでのデータ設定

```php
<?php
// home.php

// beforeAfterモジュール用データ
set_include_data('beforeAfter', [
    [
        'src' => 'images/case01.jpg',
        'alt' => 'ベランダ波板屋根破損の修繕',
        'width' => 317,
        'height' => 198,
        'ttl' => 'ベランダ波板屋根破損の修繕',
        'txt' => '強風によりベランダの波板が破損'
    ],
    [
        'src' => 'images/case02.jpg',
        'alt' => '外壁塗装リフォーム',
        'width' => 317,
        'height' => 198,
        'ttl' => '', // 空の場合は出力されない
        'txt' => '経年劣化による外壁の塗装剥がれ'
    ]
]);

// FAQモジュール用データ
set_include_data('faq', [
    [
        'question' => '工事期間はどのくらいですか？',
        'answer' => '規模によりますが、通常1-3日程度です。'
    ],
    [
        'question' => '見積もりは無料ですか？',
        'answer' => 'はい、無料で行っております。'
    ]
]);

// 会社情報（単体データ）
set_include_data('company', [
    'name' => '株式会社○○',
    'address' => '〒000-0000 東京都...',
    'tel' => '03-0000-0000',
    'email' => 'info@example.com'
]);
?>
```

### 2. セクションファイルでのループ呼び出し

```php
<?php
// case.php
auto_indent_start();
?>
<section class="bl_case">
    <div class="bl_case_inner">
        <h2 class="bl_case_header_ttl">施工実績</h2>
        
        <div class="bl_case_list"><?php
            $indent_level = 3;
            
            // beforeAfterデータを自動でループ
            render_include_loop('beforeAfter', 'parts/bl_case/beforeAfter.php');
            ?>
        </div>
    </div>
</section>
<?php
auto_indent_end(true, $indent, $current_indent, $indent_level);
?>
```

### 3. コンポーネントファイルでのデータ使用

```php
<?php
// beforeAfter.php
auto_indent_start();
?>
<div class="bl_beforeAfter">
    <div class="bl_beforeAfter_imgWrap">
        <img class="bl_beforeAfter_img" 
             src="<?php echo htmlspecialchars($module['src']); ?>" 
             alt="<?php echo htmlspecialchars($module['alt']); ?>" 
             width="<?php echo $module['width']; ?>" 
             height="<?php echo $module['height']; ?>">
    </div>
    <div class="bl_beforeAfter_txtGroup">
        <?php 
        // 条件付き出力（方法1: 手動チェック）
        if (!empty($module['ttl'])) {
            echo '<h3 class="bl_beforeAfter_txtGroup_ttl">' . htmlspecialchars($module['ttl']) . '</h3>';
        }
        
        // 条件付き出力（方法2: helper関数使用）
        echo output_if_exists('<p class="bl_beforeAfter_txtGroup_txt">%s</p>', $module['txt'] ?? '');
        ?>
    </div>
</div>
<?php
auto_indent_end(true, $indent, $current_indent, $indent_level);
?>
```

---

## データ構造のガイドライン

### 推奨されるデータ構造

```php
// 画像付きコンテンツ
set_include_data('moduleName', [
    [
        'src' => 'string',      // 必須: 画像パス
        'alt' => 'string',      // 必須: 代替テキスト
        'width' => 'integer',   // 推奨: 画像幅
        'height' => 'integer',  // 推奨: 画像高さ
        'ttl' => 'string',      // 任意: タイトル
        'txt' => 'string',      // 任意: 説明文
        'url' => 'string',      // 任意: リンクURL
        'target' => 'string'    // 任意: リンクターゲット
    ]
]);

// テキストコンテンツ
set_include_data('moduleName', [
    [
        'question' => 'string', // 必須
        'answer' => 'string',   // 必須
        'category' => 'string'  // 任意
    ]
]);
```

### データキーの命名規則

- **必須項目**: 短縮形を使用（`src`, `alt`, `ttl`, `txt`）
- **任意項目**: 明確な名前を使用（`description`, `category`, `url`）
- **真偽値**: `is_` prefixを使用（`is_featured`, `is_published`）

---

## エラーハンドリング

### 安全なデータアクセス

```php
// Null合体演算子を使用
$title = $module['ttl'] ?? '';
$description = $module['txt'] ?? 'デフォルト説明文';

// isset()でチェック
if (isset($module['ttl']) && !empty($module['ttl'])) {
    echo '<h3>' . htmlspecialchars($module['ttl']) . '</h3>';
}

// helper関数でより安全に
echo output_if_exists('<h3>%s</h3>', $module['ttl'] ?? '');
```

### データ存在チェック

```php
// モジュールデータの存在確認
$before_after_data = get_include_data('beforeAfter');
if ($before_after_data) {
    render_include_loop('beforeAfter', 'parts/beforeAfter.php');
} else {
    echo '<p>データがありません</p>';
}
```

---

## ベストプラクティス

### 1. データ設定のタイミング
- ページファイルの上部で一括設定
- インクルード前に必ずデータを設定

### 2. モジュール名の命名
- 短縮形を避け、明確な名前を使用
- キャメルケースまたはスネークケース統一

### 3. セキュリティ
- 出力時は必ず `htmlspecialchars()` を使用
- 画像パスなど信頼できるデータ以外はエスケープ

### 4. パフォーマンス
- 大量データの場合は必要な時にのみ設定
- データの再利用を積極的に行う

---

## トラブルシューティング

### よくある問題

#### データが表示されない
```php
// デバッグ用コード
var_dump(get_include_data('moduleName'));
// または
echo '<pre>' . print_r($_INCLUDE, true) . '</pre>';
```

#### ループが動作しない
- データが配列形式になっているか確認
- モジュール名のスペルミスがないか確認

#### 空データが表示される
- `output_if_exists()` を使用
- 手動で `empty()` チェックを追加

### デバッグ方法

```php
// functions.phpに追加
function debug_include_data($module_name = null) {
    global $_INCLUDE;
    
    if ($module_name) {
        echo '<pre>Module: ' . $module_name . PHP_EOL;
        print_r($_INCLUDE[$module_name] ?? 'データなし');
        echo '</pre>';
    } else {
        echo '<pre>';
        print_r($_INCLUDE);
        echo '</pre>';
    }
}

// 使用例
debug_include_data('beforeAfter');
```

---

このシステムにより、データとテンプレートを分離し、保守性と再利用性の高いPHPテンプレートシステムを構築できます。